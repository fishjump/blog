---
title: 基于UEFI的操作系统开发(一) 启动引导程序简介
date: 2021-03-06 18:28:21
tags: 操作系统
categories: 操作系统开发

title_en: osdev_1
categories_en: osdev
---
#  基于UEFI的操作系统开发（一）启动引导程序简介

有道是世间本没有路，走的人多了，便有了路。

## 什么是启动引导程序？

当计算机启动时，它会根据BIOS或是UEFI（以下均统称BIOS）指定的启动顺序，从对应的启动媒介中读取信息，如果读取到引导扇区，则执行引导扇区中的程序，装载操作系统内核，将系统控制权转交给操作系统，否则BIOS会提示类似于“找不到操作系统”之类的信息。

## 什么是引导扇区？

作为一个约定俗成的规定，一个位于磁盘的0柱面，0磁头的第1个扇区（扇区起始数字不是0，是1），扇区大小按512字节（Byte）计算，如果它的最后2字节为0x55aa，那么它就是一个引导扇区。这个规矩是当年IBM定下的，各个主板厂商在编写BIOS程序时也遵从这个规则至今。如果有机会，各位小伙伴如果有机会开发BIOS程序，也可以把它改成最后1字节必须为0x88之类的你喜欢的规则（笑。 此外，现在软盘和磁盘其实越来越少见了，我相信大多数人都用上了SSD。那么作为一个概念扩展，在使用固态硬盘或者是其他没有物理磁盘结构的启动介质时，我们可以把整个磁盘的数据抽象为一个字节数组```byte disk[]```，那么它们的0柱面0磁头1扇区其实就是和```disk[0]```到```disk[511]```，那么只要```disk[510] == 0x55 && disk[511] == 0xaa```，这个抽象出来的512字节的扇区就是引导扇区。

## 为什么我们需要启动引导程序？

理论上来说，一个操作系统确实是可以没有启动引导程序的，在编码时，我们完全可以将操作系统内核与引导程序混在一起，引导扇区的最后2字节为0x55aa即可。不过具体实践中我们几乎没有这样操作，有兴趣的小伙伴可以自己尝试写一个这样的内核（逃。

## BIOS还是UEFI？

理论上，UEFI是BIOS的一种。习惯上，BIOS指的是Legacy BIOS，而UEFI指的是UEFI BIOS。它是一种全新的启动标准，现在几乎所有x86架构的电脑的BIOS都支持UEFI模式。对于传统的引导程序，因为没有文件系统支持，我们操心磁盘的二进制内容，并且你需要用相当大一部分汇编代码来编写启动引导程序，甚至用汇编自己手写文件系统的支持。而UEFI提供了C语言的API与文件系统的支持，你只需要划分出一个ESP分区，然后往里面放入我们编写好的启动程序以及系统内核即可，对于刚入门的小伙伴，这一切都可以在一些有图形化界面的分区软件中完成。如果有想要挑战自我的小伙伴可以考虑阅读《Orange'S：一个操作系统的实现》，《30天自制操作系统》(川合秀实)等书，其中有详尽的使用汇编在LegacyBIOS下编写启动引导程序的例子。不过根据我自己的习惯，我们想要学习的是开发操作系统而不是引导程序，我们完全没有必要在这种事情上给自己增加难度。

## 启动引导程序包括什么内容？

作为一个最低限度可接受的启动引导程序，你需要完成：

- 加载系统内核程序到内存中
- 跳转到系统内核

此外，还有许多没有那么迫切的工作（几乎都是硬件检测相关，或则是你也可以为你的启动引导程序加上图形界面），我们可以在后续完善：

- 显示模式检测
- 内存检测
- 硬盘检测
- 网络检测
- etc